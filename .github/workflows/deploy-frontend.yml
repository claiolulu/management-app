name: Deploy Frontend

on:
  push:
    branches: [main]
    paths: ['frontend/**']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Setup AWS
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'eu-north-1' }}
    
    - name: Build Frontend
      run: |
        cd frontend
        npm ci
        
        # Create production config with hardcoded EC2 host
        cat > .env.production << EOF
        VITE_API_URL=http://ec2-13-61-195-234.eu-north-1.compute.amazonaws.com:5001/api
        VITE_ENVIRONMENT=production
        EOF
        
        npm run build
    
    - name: Deploy to S3
      run: |
        cd frontend
        
        # Upload files
        aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }}/ --delete
        
        # Configure CORS
        aws s3api put-bucket-cors --bucket ${{ secrets.S3_BUCKET_NAME }} --cors-configuration '{
          "CORSRules": [{
            "AllowedHeaders": ["*"],
            "AllowedMethods": ["GET", "POST", "PUT", "DELETE"],
            "AllowedOrigins": ["*"]
          }]
        }'
        
        # Set public read policy
        aws s3api put-bucket-policy --bucket ${{ secrets.S3_BUCKET_NAME }} --policy '{
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::'${{ secrets.S3_BUCKET_NAME }}'/*"
          }]
        }'
    
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ec2-13-61-195-234.eu-north-1.compute.amazonaws.com
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          # Clear old files
          sudo rm -rf /var/www/html/*
          
          # Download from S3
          aws s3 sync s3://${{ secrets.S3_BUCKET_NAME }}/ /var/www/html/
          
          # Set permissions
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 644 /var/www/html
          sudo find /var/www/html -type d -chmod 755
          
          # Reload nginx
          sudo nginx -t && sudo systemctl reload nginx
    
    - name: Summary
      run: |
        echo "âœ… Frontend deployed successfully!"
        echo "ðŸŒ S3: https://${{ secrets.S3_BUCKET_NAME }}.s3.amazonaws.com"
        echo "ðŸŒ EC2: http://ec2-13-61-195-234.eu-north-1.compute.amazonaws.com"
        echo "ðŸ”— API: http://ec2-13-61-195-234.eu-north-1.compute.amazonaws.com:5001/api"
