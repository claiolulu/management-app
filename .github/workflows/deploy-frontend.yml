name: Deploy Frontend

on:
  push:
    branches: [main]
    paths: ['frontend/**']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Setup AWS
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'eu-north-1' }}
    
    - name: Build Frontend
      timeout-minutes: 10
      run: |
        cd frontend
        echo "ðŸ“¦ Installing dependencies..."
        npm ci --no-audit --no-fund
        
        echo "âš™ï¸ Creating production config..."
        cat > .env.production << EOF
        VITE_API_URL=http://ec2-13-61-195-234.eu-north-1.compute.amazonaws.com:5001/api
        VITE_ENVIRONMENT=production
        EOF
        
        echo "ðŸ—ï¸ Building frontend..."
        npm run build
        
        echo "âœ… Build completed!"
        ls -la dist/
    
    - name: Deploy to S3
      timeout-minutes: 5
      run: |
        cd frontend
        echo "ðŸ“¤ Uploading to S3..."
        
        # Upload files
        aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }}/ --delete
        
        echo "ðŸ”§ Configuring CORS..."
        # Configure CORS
        aws s3api put-bucket-cors --bucket ${{ secrets.S3_BUCKET_NAME }} --cors-configuration '{
          "CORSRules": [{
            "AllowedHeaders": ["*"],
            "AllowedMethods": ["GET", "POST", "PUT", "DELETE"],
            "AllowedOrigins": ["*"]
          }]
        }'
        
        echo "ðŸ” Setting bucket policy..."
        # Set public read policy
        aws s3api put-bucket-policy --bucket ${{ secrets.S3_BUCKET_NAME }} --policy '{
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::'${{ secrets.S3_BUCKET_NAME }}'/*"
          }]
        }'
        
        echo "âœ… S3 deployment completed!"
    
    - name: Deploy to EC2
      timeout-minutes: 10
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ec2-13-61-195-234.eu-north-1.compute.amazonaws.com
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_SSH_KEY }}
        timeout: 300s
        script: |
          echo "ðŸš€ Starting EC2 deployment..."
          
          # Check if AWS CLI is available
          which aws || {
            echo "âš ï¸ AWS CLI not found, installing..."
            sudo apt update && sudo apt install -y awscli
          }
          
          echo "ðŸ§¹ Clearing old files..."
          sudo rm -rf /var/www/html/*
          
          echo "ðŸ“¥ Downloading from S3..."
          aws s3 sync s3://${{ secrets.S3_BUCKET_NAME }}/ /var/www/html/ --region eu-north-1
          
          echo "ðŸ” Setting permissions..."
          sudo chown -R www-data:www-data /var/www/html
          sudo chmod -R 644 /var/www/html
          sudo find /var/www/html -type d -exec chmod 755 {} \;
          
          echo "ðŸ”„ Testing and reloading nginx..."
          sudo nginx -t && sudo systemctl reload nginx
          
          echo "âœ… EC2 deployment completed!"
          echo "ðŸ“ Files in /var/www/html:"
          sudo ls -la /var/www/html/
    
    - name: Summary
      run: |
        echo "âœ… Frontend deployed successfully!"
        echo "ðŸŒ S3: https://${{ secrets.S3_BUCKET_NAME }}.s3.amazonaws.com"
        echo "ðŸŒ EC2: http://ec2-13-61-195-234.eu-north-1.compute.amazonaws.com"
        echo "ðŸ”— API: http://ec2-13-61-195-234.eu-north-1.compute.amazonaws.com:5001/api"
