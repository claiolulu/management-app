name: Deploy Frontend

on:
  push:
    branches: [main]
    paths: ['frontend/**']
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        registry-url: 'https://registry.npmjs.org'
    
    - name: Setup AWS
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: 'eu-north-1'
    
    - name: Clean npm cache and folders
      working-directory: ./frontend
      run: |
        echo "ðŸ§¹ Cleaning npm cache and folders..."
        rm -rf node_modules package-lock.json
        npm install
    
    - name: Build Frontend
      timeout-minutes: 15
      working-directory: ./frontend
      run: |
        echo "ðŸ“¦ Dependencies already installed..."
        
        echo "âš™ï¸ Creating production config..."
        cat > .env.production << EOF
        VITE_API_URL=https://ec2-13-61-195-234.eu-north-1.compute.amazonaws.com/api
        VITE_ENVIRONMENT=production
        EOF
        
        echo "ðŸ—ï¸ Building frontend..."
        npm run build
        
        echo "âœ… Build completed!"
        ls -la dist/
    
    - name: Deploy to S3
      timeout-minutes: 10
      working-directory: ./frontend
      run: |
        echo "ðŸ“¤ Uploading to S3..."
        aws s3 sync dist/ s3://gcgcm-fe/ --delete --exact-timestamps
        
        echo "ðŸ”§ Configuring CORS..."
        aws s3api put-bucket-cors --bucket gcgcm-fe --cors-configuration '{
          "CORSRules": [{
            "AllowedHeaders": ["*"],
            "AllowedMethods": ["GET", "POST", "PUT", "DELETE", "HEAD"],
            "AllowedOrigins": ["*"],
            "MaxAgeSeconds": 3000
          }]
        }'
        
        echo "ðŸ” Setting bucket policy..."
        aws s3api put-bucket-policy --bucket gcgcm-fe --policy '{
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": "*",
            "Action": "s3:GetObject",
            "Resource": "arn:aws:s3:::gcgcm-fe/*"
          }]
        }'
        
        echo "âœ… S3 deployment completed!"
    
    - name: Summary
      run: |
        echo "âœ… Frontend deployed successfully!"
        echo "ðŸŒ S3: https://gcgcm-fe.s3.eu-north-1.amazonaws.com"
        echo "ðŸ”— API: https://ec2-13-61-195-234.eu-north-1.compute.amazonaws.com/api"
