name: Deploy Frontend to S3

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - '.github/workflows/deploy-frontend.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DEPLOY_ENVIRONMENT: ${{ github.event.inputs.environment || 'production' }}

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION || 'eu-north-1' }}
    
    - name: Build Frontend with Environment Configuration
      run: |
        cd frontend
        npm ci
        
        # Create production environment file with GitHub Secrets
        echo "Creating .env.production with environment variables..."
        cat > .env.production << EOF
        # Production Environment Configuration (Auto-generated by GitHub Actions)
        VITE_API_URL=https://${{ secrets.EC2_HOST }}/api
        VITE_ENVIRONMENT=production
        VITE_ENABLE_DEBUG=false
        VITE_ENABLE_ANALYTICS=true
        VITE_API_TIMEOUT=5000
        VITE_CHUNK_SIZE_WARNING_LIMIT=1000
        EOF
        
        echo "Environment file created:"
        cat .env.production
        
        # Build with production configuration
        npm run build
        
        echo "Frontend build completed successfully!"
        echo "Build output:"
        ls -la dist/
    
    - name: Deploy Frontend to S3
      run: |
        cd frontend
        echo "Deploying frontend to S3 bucket: ${{ secrets.S3_BUCKET_NAME }}"
        
        # Sync files to S3
        aws s3 sync dist/ s3://${{ secrets.S3_BUCKET_NAME }}/ --delete
        
        # Set bucket policy for public read access
        aws s3api put-bucket-policy --bucket ${{ secrets.S3_BUCKET_NAME }} --policy '{
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": "*",
              "Action": "s3:GetObject",
              "Resource": "arn:aws:s3:::'${{ secrets.S3_BUCKET_NAME }}'/*"
            }
          ]
        }' || echo "Warning: Could not set bucket policy. May need manual configuration."
        
        # Configure website hosting
        aws s3 website s3://${{ secrets.S3_BUCKET_NAME }} --index-document index.html --error-document index.html || echo "Website configuration may already exist"
        
        echo "âœ… Frontend deployed to S3 successfully!"
    
    - name: Frontend Deployment Summary
      run: |
        echo ""
        echo "ðŸŽ‰ Frontend Deployment Completed!"
        echo ""
        echo "ðŸŒ Environment: ${{ env.DEPLOY_ENVIRONMENT }}"
        echo "ðŸ“… Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ðŸ”€ Branch: ${{ github.ref_name }}"
        echo "ðŸ“ Commit: ${{ github.sha }}"
        echo ""
        echo "ðŸ“± Frontend URLs:"
        echo "  â€¢ S3 Direct: https://${{ secrets.S3_BUCKET_NAME }}.s3.${{ secrets.AWS_REGION || 'eu-north-1' }}.amazonaws.com"
        echo "  â€¢ Main Application: https://${{ secrets.EC2_HOST }} (via Nginx proxy)"
        echo ""
        echo "âš™ï¸  Build Configuration:"
        echo "  â€¢ Node.js: 18"
        echo "  â€¢ Build Tool: Vite"
        echo "  â€¢ Environment: production"
        echo "  â€¢ API Endpoint: https://${{ secrets.EC2_HOST }}/api"
        echo ""
        echo "âœ… Frontend deployment completed successfully!"
